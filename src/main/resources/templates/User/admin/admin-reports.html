<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" class="h-100">
<head>
    <meta charset="UTF-8">
    <title>Admin â€“ Reports</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/css/bootstrap.min.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
    <link th:href="@{/styles/main.css}" rel="stylesheet"/>
    <link th:href="@{/styles/navbar.css}" rel="stylesheet"/>
    <script src="/scripts/navbar.js" defer></script>
</head>
<body>
<div th:replace="~{fragments/header :: header}"></div>

<div class="container py-4">
    <h1 class="mb-4">Manage Reports</h1>

    <div class="mb-3">
        <a th:href="@{${baseUrl}(status='NEW')}"
           th:class="'btn me-2 ' + (status=='NEW' ? 'btn-primary' : 'btn-outline-primary')">
            New
        </a>
        <a th:href="@{${baseUrl}(status='RESOLVED')}"
           th:class="'btn ' + (status=='RESOLVED' ? 'btn-primary' : 'btn-outline-primary')">
            Resolved
        </a>
    </div>

    <!-- flash messages -->
    <div th:if="${success}" class="alert alert-success" th:text="${success}"></div>
    <div th:if="${error}"   class="alert alert-danger"  th:text="${error}"></div>

    <!-- pagination top -->
    <nav aria-label="Page navigation" class="mb-3">
        <ul class="pagination justify-content-center">
            <li class="page-item" th:classappend="${currentPage == 1} ? 'disabled'">
                <a class="page-link"
                   th:href="@{${baseUrl}(status=${status},page=${currentPage - 1},size=${size})}">&laquo;</a>
            </li>
            <li class="page-item"
                th:each="i : ${#numbers.sequence(1, totalPages)}"
                th:classappend="${i == currentPage} ? 'active'">
                <a class="page-link"
                   th:href="@{${baseUrl}(status=${status},page=${i},size=${size})}"
                   th:text="${i}">1</a>
            </li>
            <li class="page-item" th:classappend="${currentPage == totalPages} ? 'disabled'">
                <a class="page-link"
                   th:href="@{${baseUrl}(status=${status},page=${currentPage + 1},size=${size})}">&raquo;</a>
            </li>
        </ul>
    </nav>

    <table class="table table-striped align-middle">
        <thead>
        <tr>
            <th>Type</th>
            <th>Target</th>
            <th>Reporter</th>
            <th>Reason</th>
            <th>Date</th>
            <th th:if="${status=='NEW'}">Actions</th>
        </tr>
        </thead>
        <tbody>
        <tr th:each="r : ${reports}">
            <td th:text="${r.type}">USER</td>
            <td th:if="${status=='NEW'}">
                <a th:if="${r.type.name()=='USER'}"
                   th:href="@{/admin/user/{id}(id=${r.targetId})}"
                   th:text="${r.targetId}">42</a>
                <a th:if="${r.type.name()=='PRODUCT'}"
                   th:href="@{/products/view/{id}(id=${r.targetId})}"
                   th:text="${r.targetId}">42</a>
            </td>
            <td th:if="${status=='RESOLVED'}" th:text="${r.targetId}">42</td>
            <td th:text="${r.reporter.username}">john</td>
            <td th:text="${r.reason}">Inappropriate content</td>
            <td th:text="${#temporals.format(r.createdAt, 'yyyy-MM-dd HH:mm')}">2025-05-20 12:34</td>
            <td th:if="${status=='NEW'}">
                <div>
                    <button class="btn btn-warning btn-sm"
                            th:if="${r.type.name()=='USER'}"
                            data-bs-toggle="modal"
                            data-bs-target="#confirmActionModal"
                            th:attr="data-report-id=${r.id},
                                     data-action='blockUser',
                                     data-label='Block this user?'">
                        <i class="bi bi-person-slash"></i> Block
                    </button>

                    <button class="btn btn-danger btn-sm"
                            th:if="${r.type.name()=='PRODUCT'}"
                            data-bs-toggle="modal"
                            data-bs-target="#confirmActionModal"
                            th:attr="data-report-id=${r.id},
                                     data-action='deleteProduct',
                                     data-label='Delete this product?'">
                        <i class="bi bi-trash"></i> Delete
                    </button>

                    <button class="btn btn-danger btn-sm"
                            th:if="${r.type.name()=='PRODUCT'}"
                            data-bs-toggle="modal"
                            data-bs-target="#confirmActionModal"
                            th:attr="data-report-id=${r.id},
                                     data-action='deleteProductAndBlockOwner',
                                     data-label='Delete product and block owner?'">
                        <i class="bi bi-shield-lock"></i> Delete & Block
                    </button>
                </div>
            </td>
        </tr>
        </tbody>
    </table>

    <!-- pagination bottom -->
    <nav aria-label="Page navigation">
        <ul class="pagination justify-content-center">
            <li class="page-item" th:classappend="${currentPage == 1} ? 'disabled'">
                <a class="page-link"
                   th:href="@{${baseUrl}(status=${status},page=${currentPage - 1},size=${size})}">&laquo;</a>
            </li>
            <li class="page-item"
                th:each="i : ${#numbers.sequence(1, totalPages)}"
                th:classappend="${i == currentPage} ? 'active'">
                <a class="page-link"
                   th:href="@{${baseUrl}(status=${status},page=${i},size=${size})}"
                   th:text="${i}">1</a>
            </li>
            <li class="page-item" th:classappend="${currentPage == totalPages} ? 'disabled'">
                <a class="page-link"
                   th:href="@{${baseUrl}(status=${status},page=${currentPage + 1},size=${size})}">&raquo;</a>
            </li>
        </ul>
    </nav>
</div>

<!-- Confirmation Modal -->
<div class="modal fade" id="confirmActionModal" tabindex="-1">
    <div class="modal-dialog">
        <form th:action="@{/admin/reports/resolve}" method="post" class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirmation</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p id="modalLabel">Are you sure?</p>
                <input type="hidden" name="reportId" id="modalReportId"/>
                <input type="hidden" name="action"   id="modalAction"/>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary"
                        data-bs-dismiss="modal">Cancel</button>
                <button type="submit" class="btn btn-primary">Yes</button>
            </div>
        </form>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
    const actionModal = document.getElementById('confirmActionModal');
    actionModal.addEventListener('show.bs.modal', event => {
        const btn    = event.relatedTarget;
        const id     = btn.getAttribute('data-report-id');
        const action = btn.getAttribute('data-action');
        const label  = btn.getAttribute('data-label');
        actionModal.querySelector('#modalReportId').value    = id;
        actionModal.querySelector('#modalAction').value      = action;
        actionModal.querySelector('#modalLabel').textContent = label;
    });
</script>

<div th:replace="~{fragments/footer :: footer}"></div>
</body>
</html>
